/*!
betajs-indexeddb - v0.0.1 - 2022-06-01
Copyright (c) Oliver Friedmann,Natasha Calleia
Apache-2.0 Software License.
*/
!function(){var e=this.subScope();e.binding("module","global:BetaJS.Data.Databases.IndexedDB"),e.binding("base","global:BetaJS"),e.binding("data","global:BetaJS.Data"),e.define("module:",function(){return{guid:"5bd48095-7aea-4962-b1d3-75a575bce453",version:"0.0.1",datetime:1654126381929}}),e.assumeVersion("base:version","~1.0.96"),e.assumeVersion("data:version","~1.0.41"),e.define("module:IndexedDBDatabaseTable",["data:Databases.DatabaseTable","base:Promise","base:Iterators.ArrayIterator","base:Tokens","base:Objs","base:Types","data:Queries"],function(e,i,r,s,a,c,o,n){var t=["weak"];return e.extend({scoped:n},function(e){return{table:function(e,n){return this._database._getTable(this._table_name,e,n)},primary_key:function(){return"id"},_insertRow:function(n){n[this.primary_key()]||(n[this.primary_key()]=s.generate_token());var t=i.create();return this.table("readwrite").success(function(e){e=e.add(n);e.onsuccess=function(){t.asyncSuccess(n)},e.onerror=function(){t.asyncError()}}),t},_removeRow:function(n){var t=i.create();return this.table("readwrite").success(function(e){e=e["delete"](n[this.primary_key()]);e.onsuccess=function(){return t.asyncSuccess()},e.onerror=function(){return t.asyncError()}}.bind(this)),t},_findOne:function(t){if(!t[this.primary_key()])return e._findOne.call(this,t);var r=i.create();return this.table().success(function(e){console.log("query[this.primary_key()]",t[this.primary_key()]);var n=e.get(t[this.primary_key()]);n.onsuccess=function(e){console.log("findOne success..."),console.log("request:",n),console.log("event:",e),r.asyncSuccess(n.result)},n.onerror=function(){r.asyncError()}}.bind(this)),r},_updateRow:function(e,r){var s=i.create();return this.table("readwrite").success(function(n){console.log("query[this.primary_key()]",e[this.primary_key()]);var t=n.get(e[this.primary_key()]);t.onsuccess=function(){a.extend(r,t.result);var e=n.put(r);e.onsuccess=function(){s.asyncSuccess(r)},e.onerror=function(){s.asyncError()}},t.onerror=function(){s.asyncError()}}.bind(this)),s},_encode:function(n){return n=a.map(n,function(e){return e&&(c.is_object(e)||c.is_array(e))?this._encode(e):e},this),t.forEach(function(e){e in n&&(n[e+"_reserved"]=n[e],delete n[e])}),n},_decode:function(n){return n=a.map(n,function(e){return e&&(c.is_object(e)||c.is_array(e))?this._decode(e):e},this),t.forEach(function(e){e+"_reserved"in n&&(n[e]=n[e+"_reserved"],delete n[e+"_reserved"])}),n},_clear:function(){var n=i.create();return this.table("readwrite").success(function(e){e=e.clear();e.onsuccess=function(){n.asyncSuccess()},e.onerror=function(){n.asyncError()}}),n},_find:function(e,n){console.log("finding... query:",e),console.log("options",n);var t=i.create();if(!(e=e||{})||c.is_empty(e))return this.table().success(function(e){e=e.getAll();e.onsuccess=function(e){t.asyncSuccess(new r(e.target.result))},e.onerror=function(){t.asyncError()}}),t;n=a.splitObject(e,function(e){return o.is_simple_atom(e)&&!c.is_boolean(e)});this.table();c.is_empty(n[0]),e=n[1],c.is_empty(e)}}})}),e.define("module:IndexedDBDatabase",["data:Databases.Database","base:Promise","module:IndexedDBDatabaseTable","base:Objs","base:Types"],function(e,r,n,s,t,i){return e.extend({scoped:i},function(t){return{constructor:function(e,n){t.constructor.call(this),this._db=e,this._config=n||{},this._indexeddb=null},destroy:function(){this._unbind(),t.destroy.call(this)},_unbind:function(){this._indexeddb&&(this._indexeddb.close(),this._indexeddb=null)},_bind:function(){if(this._indexeddb)return r.value();var n=r.create(),e=window.indexedDB.open(this._db);return e.onerror=function(e){n.asyncError(e)},e.onsuccess=function(e){this._indexeddb=e.target.result,n.asyncSuccess()}.bind(this),e.onupgradeneeded=function(e){this._indexeddb=e.target.result,s.iter(this._config,function(e,n){this._indexeddb.createObjectStore(n,{keyPath:e[0]})}.bind(this))}.bind(this),n},_tableClass:function(){return n},_getTransaction:function(e,n,t){return this._bind().mapSuccess(function(){return this._indexeddb.transaction(e,n,t)}.bind(this))},_getTable:function(n,e,t){return this._getTransaction(n,e,t).mapSuccess(function(e){return e.objectStore(n)})},deleteDatabase:function(){this._unbind();var n=r.create(),e=window.indexedDB.deleteDatabase(this._db);return e.onerror=function(e){n.asyncError(e)},e.onsuccess=function(e){n.asyncSuccess(e.result)},n}}})})}.call(Scoped);