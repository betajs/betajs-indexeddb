/*!
betajs-indexeddb - v0.0.1 - 2022-06-01
Copyright (c) Oliver Friedmann,Natasha Calleia
Apache-2.0 Software License.
*/
var Scoped=function(){var h=function(){return{get:function(e){return"undefined"!=typeof window?e?window[e]:window:"undefined"!=typeof global?e?global[e]:global:"undefined"!=typeof self?e?self[e]:self:undefined},set:function(e,t){return"undefined"!=typeof window&&(window[e]=t),"undefined"!=typeof global&&(global[e]=t),"undefined"!=typeof self&&(self[e]=t),t},getPath:function(e){if(!e)return this.get();var t=e.split(".");if(1==t.length)return this.get(e);for(var n=this.get(t[0]),r=1;r<t.length;++r){if(!n)return n;n=n[t[r]]}return n},setPath:function(e,t){var n=e.split(".");if(1==n.length)return this.set(e,t);for(var r=this.get(n[0])||this.set(n[0],{}),a=1;a<n.length-1;++a)n[a]in r||(r[n[a]]={}),r=r[n[a]];return r[n[n.length-1]]=t}}}.call(this),f=function(){return{method:function(e,t){return function(){return t.apply(e,arguments)}},extend:function(e,t){for(var n in e=e||{},t=t||{})e[n]=t[n];return e},typeOf:function(e){return"[object Array]"===Object.prototype.toString.call(e)?"array":typeof e},isEmpty:function(e){if(null==e)return!0;if("array"==this.typeOf(e))return 0===e.length;if("object"!=typeof e)return!1;for(var t in e)return!1;return!0},matchArgs:function(e,t){var n,r=0,a={};for(n in t)!0===t[n]||this.typeOf(e[r])==t[n]?(a[n]=e[r],r++):"undefined"==this.typeOf(e[r])&&r++;return a},stringify:function(e){return"function"==this.typeOf(e)?""+e:JSON.stringify(e)}}}.call(this),o=function(){return{__namespace:"Scoped",__revert:null,upgrade:function(e){var t=h.get(e||o.__namespace);if(t&&"object"===f.typeOf(t)&&t.guid===this.guid&&"string"===f.typeOf(t.version)){if(!1===this.upgradable||!1===t.upgradable)return t;for(var n=this.version.split("."),r=t.version.split("."),a=!1,i=0;i<Math.min(n.length,r.length)&&(a=parseInt(n[i],10)>parseInt(r[i],10),n[i]===r[i]);++i);return a?this.attach(e):t}return this.attach(e)},attach:function(e){e&&(o.__namespace=e);e=h.get(o.__namespace);if(e===this)return this;if(o.__revert=e)try{var t=e.__exportScoped();this.__exportBackup=this.__exportScoped(),this.__importScoped(t)}catch(n){}return h.set(o.__namespace,this),this},detach:function(e){return e&&h.set(o.__namespace,null),"undefined"!=typeof o.__revert&&h.set(o.__namespace,o.__revert),delete o.__revert,o.__exportBackup&&this.__importScoped(o.__exportBackup),this},exports:function(e,t,n){return"object"==typeof(e=e||("undefined"!=typeof module?module:null))&&e&&"exports"in e&&(n||e.exports===this||!e.exports||f.isEmpty(e.exports))&&(e.exports=t||this),this}}}.call(this);function _(e){var o={tree:"boolean"==typeof e.tree&&e.tree,global:"boolean"==typeof e.global&&e.global,root:"object"==typeof e.root?e.root:{}};function a(e){return{route:"string"==typeof e.route?e.route:null,parent:"object"==typeof e.parent?e.parent:null,ready:"boolean"==typeof e.ready&&e.ready,children:{},watchers:[],data:{},lazy:[]}}var i=a({ready:!0});if(o.tree)if(o.global){try{window&&(i.data=window)}catch(t){}try{global&&(i.data=global)}catch(t){}try{self&&(i.data=self)}catch(t){}}else i.data=o.root;function s(e){if(!e.ready)if(e.parent&&!e.parent.ready)s(e.parent);else if(e.route&&e.parent&&e.route in e.parent.data){e.data=e.parent.data[e.route],e.ready=!0;for(var t,n=0;n<e.watchers.length;++n)e.watchers[n].callback.call(e.watchers[n].context||this,e.data);for(t in e.watchers=[],e.children)s(e.children[t])}}function c(e,t){if("object"==typeof t&&e.ready)for(var n in t)e.data[n]=t[n];else e.data=t;if("object"==typeof t)for(var r in t)e.children[r]&&(e.children[r].data=t[r]);for(var a in!function i(e){if(!e.ready){e.parent&&!e.parent.ready&&i(e.parent),e.ready=!0,e.parent&&o.tree&&"object"==typeof e.parent.data&&(e.parent.data[e.route]=e.data);for(var t=0;t<e.watchers.length;++t)e.watchers[t].callback.call(e.watchers[t].context||this,e.data);e.watchers=[]}}(e),e.children)s(e.children[a])}function u(e){if(!e)return i;for(var t=e.split("."),n=i,r=0;r<t.length;++r)t[r]in n.children?n=n.children[t[r]]:(n.children[t[r]]=a({parent:n,route:t[r]}),s(n=n.children[t[r]]));return n}return{extend:function(e,t){c(u(e),t)},set:function(e,t){e=u(e);if(e.data){var n=e;if(n.ready&&n.data)for(var r in n.data)delete n.data[r]}c(e,t)},get:function(e){e=u(e);return e.ready?e.data:null},lazy:function(e,t,n){e=u(e);e.ready?t(n||this,e.data):e.lazy.push({callback:t,context:n})},digest:function(e){s(u(e))},obtain:function(e,t,n){!function(e,t,n){var r;e.ready?t.call(n||this,e.data):(e.watchers.push({callback:t,context:n}),0<e.lazy.length&&(r=function(e){var t;0<e.lazy.length&&((t=e.lazy.shift()).callback.call(t.context||this,e.data),r(e))})(e))}(u(e),t,n)},unresolvedWatchers:function(e){return function a(e,t,n){for(var r in n=n||[],!(e=e||i).ready&&0===e.lazy.length&&0<e.watchers.length&&n.push(t),e.children)r=e.children[r],n=a(r,(t?t+".":"")+r.route,n);return n}(u(e),e)},__export:function(){return{options:o,nsRoot:i}},__import:function(e){o=e.options,i=e.nsRoot}}}var t=_({tree:!0,global:!0}),n=_({tree:!0}),r=function b(e,t,n,r){var a=null,i=[],o=t,s=n,c=r,u=_({tree:!0}),d=_({tree:!1}),l={global:{namespace:c},root:{namespace:s},local:{namespace:u},"default":{namespace:d},parent:{namespace:o},scope:{namespace:u,readonly:!1}},p=function(i,o,s){var c=f.matchArgs(i,{options:"object",namespaceLocator:!0,dependencies:"array",hiddenDependencies:"array",callback:!0,context:"object"}),e=f.extend({lazy:this.options.lazy},c.options||{}),u=this.resolve(c.namespaceLocator),t=function(){this.require(c.dependencies,c.hiddenDependencies,function(){for(var e=[],t=0;t<arguments.length;++t)e.push(arguments[t]);if(e[e.length-1].ns=u,this.options.compile){for(var n=[],r=0;r<i.length;++r)n.push(f.stringify(i[r]));this.compiled+=this.options.ident+"."+o+"("+n.join(", ")+");\n\n"}this.options.dependencies&&(this.dependencies[u.path]=this.dependencies[u.path]||{},c.dependencies&&c.dependencies.forEach(function(e){this.dependencies[u.path][this.resolve(e).path]=!0},this),c.hiddenDependencies&&c.hiddenDependencies.forEach(function(e){this.dependencies[u.path][this.resolve(e).path]=!0},this));var a=this.options.compile?{}:c.callback.apply(c.context||this,e);s.call(this,u,a)},this)};return e.lazy?u.namespace.lazy(u.path,t,this):t.apply(this),this};return{getGlobal:f.method(h,h.getPath),setGlobal:f.method(h,h.setPath),options:{lazy:!1,ident:"Scoped",compile:!1,dependencies:!1},compiled:"",dependencies:{},nextScope:function(){return a=a||b(0,u,s,c)},subScope:function(){var e=this.nextScope();return i.push(e),a=null,e},binding:function(e,t,n){return l[e]&&l[e].readonly||(t="string"!=f.typeOf(t)?{namespace:_({tree:!0,root:t}),path:null}:this.resolve(t),l[e]=f.extend(n,t)),this},resolve:function(e){if(1==(e=e.split(":")).length)throw"The locator '"+e[0]+"' requires a namespace.";var t=l[e[0]];if(t)return{namespace:t.namespace,path:t.path&&e[1]?t.path+"."+e[1]:t.path||e[1]};throw"The namespace '"+e[0]+"' has not been defined (yet)."},define:function(){return p.call(this,arguments,"define",function(e,t){if(e.namespace.get(e.path))throw"Scoped namespace "+e.path+" has already been defined. Use extend to extend an existing namespace instead";e.namespace.set(e.path,t)})},assumeVersion:function(){var i=f.matchArgs(arguments,{assumption:!0,dependencies:"array",callback:!0,context:"object",error:"string"}),e=i.dependencies||[];e.unshift(i.assumption),this.require(e,function(){var e=arguments,t=e[0].replace(/[^\d\.]/g,"");e[0]=t.split(".");for(var n=0;n<e[0].length;++n)e[0][n]=parseInt(e[0][n],10);if("function"===f.typeOf(i.callback)){if(!i.callback.apply(i.context||this,i))throw"Scoped Assumption '"+i.assumption+"' failed, value is "+t+(i.error?", but assuming "+i.error:"")}else for(var r=(i.callback+"").replace(/[^\d\.]/g,"").split("."),a=0;a<Math.min(e[0].length,r.length);++a)if(parseInt(r[a],10)>e[0][a])throw"Scoped Version Assumption '"+i.assumption+"' failed, value is "+t+", but assuming at least "+i.callback})},extend:function(){return p.call(this,arguments,"extend",function(e,t){e.namespace.extend(e.path,t)})},require:function(){var t=f.matchArgs(arguments,{dependencies:"array",hiddenDependencies:"array",callback:"function",context:"object"}),e=(t.callback=t.callback||function(){},t.dependencies||[]),n=e.concat(t.hiddenDependencies||[]),r=n.length,a=[],i={};if(r)for(var o=function(e){this.i<a.length&&(a[this.i]=e),0==--r&&(a.push(i),t.callback.apply(t.context||this.ctx,a))},s=0;s<n.length;++s){var c=this.resolve(n[s]);s<e.length&&a.push(null),c.namespace.obtain(c.path,o,{ctx:this,i:s})}else a.push(i),t.callback.apply(t.context||this,a);return this},digest:function(e){return(e=this.resolve(e)).namespace.digest(e.path),this},unresolved:function(e){return(e=this.resolve(e)).namespace.unresolvedWatchers(e.path)},__export:function(){return{parentNamespace:o.__export(),rootNamespace:s.__export(),globalNamespace:c.__export(),localNamespace:u.__export(),privateNamespace:d.__export()}},__import:function(e){o.__import(e.parentNamespace),s.__import(e.rootNamespace),c.__import(e.globalNamespace),u.__import(e.localNamespace),d.__import(e.privateNamespace)}}}(0,n,n,t),e=f.extend(r,function(){return{guid:"4b6878ee-cb6a-46b3-94ac-27d91f58d666",version:"0.0.22",upgradable:!0,upgrade:o.upgrade,attach:o.attach,detach:o.detach,exports:o.exports,__exportScoped:function(){return{globalNamespace:t.__export(),rootNamespace:n.__export(),rootScope:r.__export()}},__importScoped:function(e){t.__import(e.globalNamespace),n.__import(e.rootNamespace),r.__import(e.rootScope)}}}.call(this));return(e=e.upgrade()).exports(),e}.call(this);!function(){var e=this.subScope();e.binding("module","global:BetaJS.Data.Databases.IndexedDB"),e.binding("base","global:BetaJS"),e.binding("data","global:BetaJS.Data"),e.define("module:",function(){return{guid:"5bd48095-7aea-4962-b1d3-75a575bce453",version:"0.0.1",datetime:1654126381929}}),e.assumeVersion("base:version","~1.0.96"),e.assumeVersion("data:version","~1.0.41"),e.define("module:IndexedDBDatabaseTable",["data:Databases.DatabaseTable","base:Promise","base:Iterators.ArrayIterator","base:Tokens","base:Objs","base:Types","data:Queries"],function(e,i,r,a,o,s,c,t){var n=["weak"];return e.extend({scoped:t},function(e){return{table:function(e,t){return this._database._getTable(this._table_name,e,t)},primary_key:function(){return"id"},_insertRow:function(t){t[this.primary_key()]||(t[this.primary_key()]=a.generate_token());var n=i.create();return this.table("readwrite").success(function(e){e=e.add(t);e.onsuccess=function(){n.asyncSuccess(t)},e.onerror=function(){n.asyncError()}}),n},_removeRow:function(t){var n=i.create();return this.table("readwrite").success(function(e){e=e["delete"](t[this.primary_key()]);e.onsuccess=function(){return n.asyncSuccess()},e.onerror=function(){return n.asyncError()}}.bind(this)),n},_findOne:function(n){if(!n[this.primary_key()])return e._findOne.call(this,n);var r=i.create();return this.table().success(function(e){console.log("query[this.primary_key()]",n[this.primary_key()]);var t=e.get(n[this.primary_key()]);t.onsuccess=function(e){console.log("findOne success..."),console.log("request:",t),console.log("event:",e),r.asyncSuccess(t.result)},t.onerror=function(){r.asyncError()}}.bind(this)),r},_updateRow:function(e,r){var a=i.create();return this.table("readwrite").success(function(t){console.log("query[this.primary_key()]",e[this.primary_key()]);var n=t.get(e[this.primary_key()]);n.onsuccess=function(){o.extend(r,n.result);var e=t.put(r);e.onsuccess=function(){a.asyncSuccess(r)},e.onerror=function(){a.asyncError()}},n.onerror=function(){a.asyncError()}}.bind(this)),a},_encode:function(t){return t=o.map(t,function(e){return e&&(s.is_object(e)||s.is_array(e))?this._encode(e):e},this),n.forEach(function(e){e in t&&(t[e+"_reserved"]=t[e],delete t[e])}),t},_decode:function(t){return t=o.map(t,function(e){return e&&(s.is_object(e)||s.is_array(e))?this._decode(e):e},this),n.forEach(function(e){e+"_reserved"in t&&(t[e]=t[e+"_reserved"],delete t[e+"_reserved"])}),t},_clear:function(){var t=i.create();return this.table("readwrite").success(function(e){e=e.clear();e.onsuccess=function(){t.asyncSuccess()},e.onerror=function(){t.asyncError()}}),t},_find:function(e,t){console.log("finding... query:",e),console.log("options",t);var n=i.create();if(!(e=e||{})||s.is_empty(e))return this.table().success(function(e){e=e.getAll();e.onsuccess=function(e){n.asyncSuccess(new r(e.target.result))},e.onerror=function(){n.asyncError()}}),n;t=o.splitObject(e,function(e){return c.is_simple_atom(e)&&!s.is_boolean(e)});this.table();s.is_empty(t[0]),e=t[1],s.is_empty(e)}}})}),e.define("module:IndexedDBDatabase",["data:Databases.Database","base:Promise","module:IndexedDBDatabaseTable","base:Objs","base:Types"],function(e,r,t,a,n,i){return e.extend({scoped:i},function(n){return{constructor:function(e,t){n.constructor.call(this),this._db=e,this._config=t||{},this._indexeddb=null},destroy:function(){this._unbind(),n.destroy.call(this)},_unbind:function(){this._indexeddb&&(this._indexeddb.close(),this._indexeddb=null)},_bind:function(){if(this._indexeddb)return r.value();var t=r.create(),e=window.indexedDB.open(this._db);return e.onerror=function(e){t.asyncError(e)},e.onsuccess=function(e){this._indexeddb=e.target.result,t.asyncSuccess()}.bind(this),e.onupgradeneeded=function(e){this._indexeddb=e.target.result,a.iter(this._config,function(e,t){this._indexeddb.createObjectStore(t,{keyPath:e[0]})}.bind(this))}.bind(this),t},_tableClass:function(){return t},_getTransaction:function(e,t,n){return this._bind().mapSuccess(function(){return this._indexeddb.transaction(e,t,n)}.bind(this))},_getTable:function(t,e,n){return this._getTransaction(t,e,n).mapSuccess(function(e){return e.objectStore(t)})},deleteDatabase:function(){this._unbind();var t=r.create(),e=window.indexedDB.deleteDatabase(this._db);return e.onerror=function(e){t.asyncError(e)},e.onsuccess=function(e){t.asyncSuccess(e.result)},t}}})})}.call(Scoped);